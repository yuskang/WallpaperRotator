---
index: 9
gemini_id: bb030a25e2bdc210
synced_at: 2026-01-29T06:32:52.910Z
---

## Q

工作排程器不行

## A

這真的很令人沮喪，Windows 的自動化執行常常卡在「權限」與「視窗隱藏」這兩件事上。

既然 `VBS` 和 `工作排程器` 都失敗了，我們採用**最暴力但也最穩定的「程式碼自隱藏 (Self-Hiding)」法**。

我們直接修改 `AutoWallpaper.ps1` 的程式碼，**讓腳本自己去呼叫 Windows API 把自己的黑視窗關掉**。這樣您就不需要 VBS，也不用管工作排程器的設定，直接把腳本捷徑丟進啟動資料夾即可。

### 終極解法：讓 PowerShell 腳本「自我隱藏」

請依照以下步驟操作，這是目前成功率最高的方法：

#### 步驟 1：修改 AutoWallpaper.ps1

請用 VS Code 或記事本開啟您的 `AutoWallpaper.ps1`，**清空所有內容**，然後貼上以下**完整的新程式碼**。

這段程式碼在原本的功能最上方，加入了一段 `ShowWindowAsync` 的 API 呼叫，它一啟動就會立刻把自己「變不見」。

```
# ==========================================
# 區塊 1: 自我隱藏視窗 (新增的核心功能)
# ==========================================
$t = '[DllImport("user32.dll")] public static extern bool ShowWindow(int handle, int state);'
add-type -name win -member $t -namespace native
$hwnd = (Get-Process -Id $PID).MainWindowHandle
# 0 = Hide (隱藏), 1 = Normal (顯示)
[native.win]::ShowWindow($hwnd, 0)

# ==========================================
# 區塊 2: 您的桌布自動切換邏輯
# ==========================================
Add-Type @"
using System;
using System.Runtime.InteropServices;
using Microsoft.Win32;

public class Wallpaper {
    [DllImport("user32.dll", CharSet = CharSet.Auto)]
    public static extern int SystemParametersInfo(int uAction, int uParam, string lpvParam, int fuWinIni);
}
"@

# --- 請確認圖片路徑 (絕對路徑) ---
$LandscapePath = "C:\Wallpapers\Landscape.png"
$PortraitPath  = "C:\Wallpapers\Portrait.png"

$SPI_SETDESKWALLPAPER = 0x0014
$UpdateIniFile = 0x01
$SendWinIniChange = 0x02
$CurrentState = "Unknown"

# 設定桌布樣式函數 (Fit = 6)
function Set-WallpaperStyle {
    Set-ItemProperty -Path "HKCU:\Control Panel\Desktop" -Name WallpaperStyle -Value "6"
    Set-ItemProperty -Path "HKCU:\Control Panel\Desktop" -Name TileWallpaper -Value "0"
}

while ($true) {
    Add-Type -AssemblyName System.Windows.Forms
    $Screen = [System.Windows.Forms.Screen]::PrimaryScreen
    $Width = $Screen.Bounds.Width
    $Height = $Screen.Bounds.Height
    
    if ($Width -gt $Height) {
        $TargetFile = $LandscapePath
        $TargetState = "Landscape"
    } else {
        $TargetFile = $PortraitPath
        $TargetState = "Portrait"
    }

    if ($CurrentState -ne $TargetState) {
        if (Test-Path $TargetFile) {
            Set-WallpaperStyle
            [Wallpaper]::SystemParametersInfo($SPI_SETDESKWALLPAPER, 0, $TargetFile, $UpdateIniFile -bor $SendWinIniChange)
            $CurrentState = $TargetState
        }
    }
    
    # 每 2 秒檢查一次
    Start-Sleep -Seconds 2
}

```

#### 步驟 2：建立簡單捷徑 (不用 VBS 了)

1.  存檔後，對著 `AutoWallpaper.ps1` 檔案按右鍵 -> **建立捷徑**。
    
2.  按下 `Win + R`，輸入 `shell:startup` 並按 Enter。
    
3.  將剛剛建立的 **捷徑** 拖進這個啟動資料夾。
    

#### 步驟 3：測試

1.  雙擊這個捷徑。
    
2.  您會看到一個藍色視窗**閃現大約 0.5 秒**，然後瞬間消失。
    
3.  試著旋轉螢幕，確認桌布是否有切換。
    
4.  如果有切換，恭喜您！下次重開機它就會自動執行並隱藏了。
    

* * *

### 為什麼之前工作排程器會失敗？ (技術解釋)

工作排程器失敗的原因通常有兩個，這也是 Windows 平板常見的坑：

1.  **使用者互動限制**：原本的腳本使用了 `System.Windows.Forms.Screen` 來偵測螢幕解析度。如果您在工作排程器勾選了「不論使用者登入與否均執行」，系統會用背景帳戶執行，這個帳戶**沒有螢幕**，所以腳本讀不到解析度就報錯停止了。
    
2.  **機碼寫入位置**：腳本試圖修改 `HKCU` (Current User)，如果是用 SYSTEM 權限執行，它會改到系統的機碼，而不是您當前使用者的，導致桌布樣式（填滿/符合）設定無效。
    

使用上面的**自隱藏腳本 + 啟動資料夾**，即確保了程式是用您的帳號執行（讀得到螢幕、改得動設定），又解決了視窗礙眼的問題。
