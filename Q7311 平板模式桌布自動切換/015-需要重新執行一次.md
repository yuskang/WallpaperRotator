---
index: 15
gemini_id: 7cada1c3f13558ae
synced_at: 2026-01-29T06:32:53.044Z
---

## Q

需要重新執行一次

## A

這是一個非常關鍵的錯誤，感謝您的回報。

**問題出在哪裡？** 在上一版程式碼中，`Add-Type -AssemblyName System.Windows.Forms` 這行指令被放在了 `while` 迴圈**裡面**。

1.  第一次執行時：成功載入，程式運作正常。
    
2.  第二次迴圈（2秒後）：程式試圖**再次載入**同一個元件，系統報錯（因為已經載入了）。
    
3.  雖然 `try-catch` 抓住了錯誤沒讓程式崩潰，但因為報錯，導致後面的**螢幕解析度偵測代碼被跳過**，所以程式變成了「雖然活著，但不再更新數據」的殭屍狀態。
    

**修正方案：** 將載入元件的指令移到最上方（只執行一次），並優化偵測邏輯。

請使用這份**修正後的 V4 版本**，這絕對能解決「只跑一次就停住」的問題。

* * *

# Windows 平板螢幕旋轉自動切換桌布教程 (V4 穩定修正版)

**適用機型**：Fujitsu Q7311 / Q738 及各類 Windows 10/11 平板電腦。

## 前言

修正了前一版本因重複載入元件導致「切換一次後失效」的 Bug。此版本將確保程式在背景持續、穩定地監控旋轉。

* * *

## 步驟一：準備桌布圖片

1.  準備兩張圖片（橫向/直向），建議使用 **.png** 或 **.jpg**。
    
2.  建立資料夾 `C:\Wallpapers` 並放入圖片：
    
    *   `C:\Wallpapers\Landscape.png`
        
    *   `C:\Wallpapers\Portrait.png`
        

* * *

## 步驟二：設定 Windows 底色 (黑邊準備)

為了讓圖片在「符合 (Fit)」模式下，留白處呈現完美黑色：

1.  桌面右鍵 -> **個人化** -> **背景**。
    
2.  將背景切換為 **純色**，選擇 **黑色**。
    
3.  設定完成後關閉視窗。
    

* * *

## 步驟三：建立自動切換腳本 (AutoWallpaper.ps1)

**請務必將舊的檔案內容清空，完全替換為以下代碼：**

```
# ==========================================
# V4 穩定版：修正重複載入導致失效的問題
# ==========================================

# 1. 啟動緩衝 (避免開機搶快失敗)
Start-Sleep -Seconds 3

# 2. 載入必要的系統元件 (只載入一次，放在迴圈外)
try {
    Add-Type -AssemblyName System.Windows.Forms
} catch {
    # 如果已經載入過，忽略錯誤
}

$t = @'
using System;
using System.Runtime.InteropServices;
using Microsoft.Win32;
public class Wallpaper {
    [DllImport("user32.dll", CharSet = CharSet.Auto)]
    public static extern int SystemParametersInfo(int uAction, int uParam, string lpvParam, int fuWinIni);
}
[DllImport("user32.dll")]
public static extern bool ShowWindow(int handle, int state);
'@
Add-Type -Name win -Member $t -Namespace native

# 3. 執行視窗隱藏
$hwnd = (Get-Process -Id $PID).MainWindowHandle
if ($hwnd -ne 0) { 
    [native.win]::ShowWindow($hwnd, 0) | Out-Null 
}

# ------------------------------------------
# 設定區：請確認路徑正確
# ------------------------------------------
$LandscapePath = "C:\Wallpapers\Landscape.png"
$PortraitPath  = "C:\Wallpapers\Portrait.png"

$SPI_SETDESKWALLPAPER = 0x0014
$UpdateIniFile = 0x01
$SendWinIniChange = 0x02
$CurrentState = "Unknown"

# 設定桌布樣式函數 (Fit = 6)
function Set-WallpaperStyle {
    Set-ItemProperty -Path "HKCU:\Control Panel\Desktop" -Name WallpaperStyle -Value "6" | Out-Null
    Set-ItemProperty -Path "HKCU:\Control Panel\Desktop" -Name TileWallpaper -Value "0" | Out-Null
}

# 4. 主迴圈 (無窮迴圈)
while ($true) {
    try {
        # 每次迴圈重新抓取螢幕資訊
        $Screen = [System.Windows.Forms.Screen]::PrimaryScreen
        $Width = $Screen.Bounds.Width
        $Height = $Screen.Bounds.Height
        
        # 判斷方向
        if ($Width -gt $Height) {
            $TargetFile = $LandscapePath
            $TargetState = "Landscape"
        } else {
            $TargetFile = $PortraitPath
            $TargetState = "Portrait"
        }

        # 只有狀態改變時才執行換圖動作
        if ($CurrentState -ne $TargetState) {
            
            # 確保檔案存在才執行
            if (Test-Path $TargetFile) {
                Set-WallpaperStyle
                # 執行換圖
                [void][Wallpaper]::SystemParametersInfo($SPI_SETDESKWALLPAPER, 0, $TargetFile, $UpdateIniFile -bor $SendWinIniChange)
                
                # 更新狀態，避免重複執行
                $CurrentState = $TargetState
            }
        }
    } catch {
        # 如果發生單次錯誤，忽略並繼續下一次迴圈
    }
    
    # 暫停 2 秒再檢查
    Start-Sleep -Seconds 2
}

```

* * *

## 步驟四：設定開機自動執行 (建立執行捷徑)

如果您之前已經建立過捷徑，**不需要重新建立**，只要確認您的捷徑內容包含 `-WindowStyle Hidden` 即可。若尚未建立，請依下述步驟：

1.  在桌面空白處按右鍵 -> **新增** -> **捷徑**。
    
2.  在「輸入項目的位置」欄位中，**完整複製並貼上**以下指令（請確認只有一行）：
    
    ```
    powershell.exe -WindowStyle Hidden -ExecutionPolicy Bypass -File "C:\Wallpapers\AutoWallpaper.ps1"
    
    ```
    
3.  按 **下一步**，名稱輸入 `AutoWallpaper`，按 **完成**。
    
4.  按下鍵盤 `Win + R`，輸入 `shell:startup` 並按 Enter。
    
5.  將剛剛建立在桌面的捷徑，拖進這個「啟動」資料夾中。
    

* * *

## 如何驗證修復成功？

這個版本的腳本修改了結構，現在即使您長時間不旋轉，腳本也不會報錯停止。

1.  **手動測試**：您可以直接雙擊桌面的捷徑（視窗閃退是正常的）。
    
2.  **旋轉測試**：請連續旋轉螢幕兩次：
    
    *   先轉直（等待 2-3 秒，桌布變直）。
        
    *   再轉橫（等待 2-3 秒，桌布變橫）。
        
    *   **如果兩次都能變換，代表修復成功。**
